<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>MALLANG Beauty Chat</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html { height: 100%; overflow: hidden; touch-action: pan-y; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #FAF9F6;
  overflow: hidden;
  width: 100%;
  height: 100%;
  height: 100dvh;
}
.screen { display: none; height: 100%; width: 100%; overflow-x: hidden; flex-direction: column; }
@supports (height: 100dvh) { .screen { height: 100dvh; } }
.screen.active { display: flex; }

/* === ë¡œë”© === */
.loading-screen { align-items: center; justify-content: center; }
.loading-spinner { width: 30px; height: 30px; border: 3px solid #E5E5E5; border-top-color: #C9A063; border-radius: 50%; animation: spin 0.8s linear infinite; margin-top: 1rem; }
@keyframes spin { to { transform: rotate(360deg); } }

/* === ê³µí†µ === */
.logo { font-size: 2.5rem; font-weight: 300; letter-spacing: 0.3em; margin-bottom: 1rem; }
.subtitle { color: #666; margin-bottom: 3rem; }
.gold-btn { padding: 0.8rem 2rem; background: #C9A063; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; width: 100%; }
.gold-btn:hover { background: #B8914F; }
.gold-btn:disabled { background: #ccc; cursor: not-allowed; }

/* === ì–¸ì–´ ì„ íƒ === */
.lang-screen { align-items: center; justify-content: center; padding: 2rem; }
.lang-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; max-width: 400px; width: 100%; }
.lang-btn {
  padding: 1.5rem;
  border: 2px solid #E5E5E5;
  background: white;
  border-radius: 12px;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.3s;
}
.lang-btn:hover { border-color: #C9A063; transform: translateY(-2px); }

/* === ë¡œê·¸ì¸/íšŒì›ê°€ì… === */
.auth-screen { align-items: center; justify-content: center; padding: 2rem; }
.auth-form { width: 100%; max-width: 380px; }
.auth-form h2 { text-align: center; margin-bottom: 1.5rem; }
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: #555; }
.form-group input, .form-group select { width: 100%; padding: 0.7rem; border: 1px solid #DDD; border-radius: 8px; font-size: 1rem; }
.auth-btn { width: 100%; padding: 0.8rem; background: #C9A063; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 0.5rem; }
.auth-btn:hover { background: #B8914F; }
.auth-btn:disabled { background: #ccc; }
.auth-error { background: #fee; color: #c33; padding: 0.7rem; border-radius: 8px; display: none; margin-bottom: 1rem; font-size: 0.9rem; }
.auth-switch { text-align: center; margin-top: 1rem; font-size: 0.9rem; color: #666; }
.auth-switch a { color: #C9A063; cursor: pointer; text-decoration: underline; }
.role-toggle { display: flex; border: 2px solid #E5E5E5; border-radius: 8px; overflow: hidden; margin-bottom: 1.5rem; }
.role-toggle button { flex: 1; padding: 0.6rem; border: none; background: white; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
.role-toggle button.active { background: #C9A063; color: white; }
.designer-fields { display: none; }
.designer-fields.show { display: block; }

/* === ì±„íŒ… ëª©ë¡ === */
.chatlist-header {
  background: white;
  padding: 1rem 1.2rem;
  border-bottom: 1px solid #E5E5E5;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.chatlist-header h2 { font-size: 1.2rem; }
.chatlist-header-btns { display: flex; gap: 0.5rem; }
.chatlist-header-btns button {
  padding: 0.4rem 0.8rem;
  border: 1px solid #DDD;
  background: white;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.85rem;
}
.chatlist-items { flex: 1; overflow-y: auto; }
.chatlist-item {
  padding: 1rem 1.2rem;
  border-bottom: 1px solid #F0F0F0;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.8rem;
  transition: background 0.2s;
}
.chatlist-item:hover { background: #F9F5ED; }
.chatlist-avatar {
  width: 48px; height: 48px;
  border-radius: 50%;
  background: #C9A063;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  font-weight: bold;
  flex-shrink: 0;
}
.chatlist-avatar.designer { background: #7C6BC4; }
.chatlist-avatar.admin { background: #C9A063; }
.chatlist-info { flex: 1; min-width: 0; }
.chatlist-name { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 0.4rem; }
.chatlist-preview { color: #888; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.2rem; }
.chatlist-meta { text-align: right; flex-shrink: 0; }
.chatlist-time { font-size: 0.75rem; color: #999; }
.chatlist-unread { background: #C9A063; color: white; font-size: 0.7rem; padding: 2px 7px; border-radius: 10px; margin-top: 0.3rem; display: inline-block; }
.no-chats { padding: 3rem; text-align: center; color: #999; }

/* === ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬ === */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal-box {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  width: 90%;
  max-width: 360px;
}
.modal-box h3 { margin-bottom: 1rem; text-align: center; }
.modal-box input { width: 100%; padding: 0.7rem; border: 1px solid #DDD; border-radius: 8px; font-size: 1rem; margin-bottom: 0.8rem; }
.modal-result { margin-top: 0.5rem; padding: 0.8rem; border-radius: 8px; display: none; }
.modal-result.found { display: block; background: #F9F5ED; }
.modal-result.not-found { display: block; background: #FEE; color: #c33; text-align: center; }
.modal-result-user { display: flex; align-items: center; gap: 0.8rem; }
.modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; position: absolute; right: 1rem; top: 0.5rem; }

/* === ì±„íŒ…ë°© === */
.chatroom-header {
  background: white;
  padding: 0.8rem 1rem;
  border-bottom: 1px solid #E5E5E5;
  display: flex;
  align-items: center;
  gap: 0.8rem;
}
.back-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.2rem; }
.chatroom-header-info { flex: 1; }
.chatroom-header-info h3 { font-size: 1rem; }
.chatroom-header-info p { font-size: 0.8rem; color: #888; }
.lang-badge { background: #F0F0F0; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; }
.logout-btn { background: none; border: 1px solid #DDD; padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  background: #FAF9F6;
}
.message { display: flex; flex-direction: column; }
.from-me { align-items: flex-end; }
.from-them { align-items: flex-start; }
.msg-bubble {
  max-width: 90%;
  padding: 0.8rem 1rem;
  border-radius: 12px;
  word-wrap: break-word;
  position: relative;
  letter-spacing: 0.03em;
  line-height: 1.7;
}
.from-me .msg-bubble { background: #C9A063; color: white; border-bottom-right-radius: 4px; }
.from-them .msg-bubble { background: white; border: 1px solid #E5E5E5; border-bottom-left-radius: 4px; }
.msg-time { font-size: 0.7rem; color: #999; margin-top: 0.2rem; }
.msg-delete { position: absolute; top: -8px; right: -8px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; cursor: pointer; display: none; line-height: 20px; text-align: center; }
.msg-bubble:hover .msg-delete { display: block; }
.msg-highlight { background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
.msg-img { max-width: 240px; border-radius: 8px; margin: 4px 0; display: block; cursor: pointer; }
.msg-link { color: inherit; text-decoration: underline; word-break: break-all; }
.msg-link-btn {
  display: inline-block;
  padding: 8px 16px;
  background: #C9A063;
  color: white !important;
  border-radius: 20px;
  text-decoration: none;
  margin: 4px 0;
  font-size: 0.85rem;
}

/* === ì…ë ¥ ì˜ì—­ === */
.input-area {
  background: white;
  padding: 0.8rem;
  padding-bottom: max(1rem, calc(0.8rem + env(safe-area-inset-bottom, 10px)));
  border-top: 1px solid #E5E5E5;
  display: flex;
  gap: 0.5rem;
  align-items: flex-end;
}
.msg-input {
  flex: 1;
  padding: 0.6rem 0.8rem;
  border: 1px solid #DDD;
  border-radius: 20px;
  font-size: 0.95rem;
  resize: none;
  overflow-y: hidden;
  max-height: 120px;
  font-family: inherit;
}
.img-upload-btn {
  width: 36px; height: 36px;
  border-radius: 50%;
  border: 1px solid #DDD;
  background: white;
  cursor: pointer;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.send-btn {
  padding: 0.5rem 1rem;
  background: #C9A063;
  color: white;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9rem;
  flex-shrink: 0;
}
.img-preview { position: relative; margin-bottom: 0.5rem; }
.img-preview img { max-height: 100px; border-radius: 8px; }
.img-preview-remove { position: absolute; top: -6px; right: -6px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 0.8rem; }

/* === ë©”ë‰´ ì‚¬ì´ë“œë°” === */
.menu-sidebar {
  width: 180px;
  min-width: 180px;
  background: white;
  border-right: 1px solid #E5E5E5;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  transition: width 0.3s, min-width 0.3s;
}
.menu-sidebar.expanded { width: 320px; min-width: 320px; }
.menu-tabs { display: flex; flex-direction: column; }
.menu-tab {
  padding: 1rem 1.2rem;
  cursor: pointer;
  font-size: 0.95rem;
  border-bottom: 1px solid #F0F0F0;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.menu-tab:hover, .menu-tab.active { background: #F9F5ED; color: #C9A063; }
.menu-content { padding: 0.8rem; font-size: 0.85rem; overflow-y: auto; flex: 1; }
.menu-content h4 { margin: 0.8rem 0 0.3rem; color: #C9A063; font-size: 0.9rem; }
.price-row { display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #F8F8F8; font-size: 0.85rem; }
.divider { height: 1px; background: #E5E5E5; margin: 0.8rem 0; }
.menu-content .note { font-size: 0.8rem; color: #888; margin: 0.3rem 0; }
.menu-content .link { color: #C9A063; text-decoration: underline; cursor: pointer; }

/* === ë©”ë‰´ ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼) === */
.menu-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100%;
  background: rgba(0,0,0,0.3);
  z-index: 999;
}
.menu-overlay.active { display: block; }

/* === ìŠ¤íƒœí”„ í™”ë©´ === */
.staff-screen { display: none; flex-direction: row; height: 100%; }
.customer-list {
  width: 300px;
  border-right: 1px solid #E5E5E5;
  display: flex;
  flex-direction: column;
  background: white;
}
.list-header { padding: 1rem; border-bottom: 1px solid #E5E5E5; }
.list-header h2 { margin-bottom: 0.5rem; }
.search-box { width: 100%; padding: 0.5rem; border: 1px solid #DDD; border-radius: 6px; }
.customer-items { overflow-y: auto; flex: 1; }
.customer-item {
  padding: 0.8rem 1rem;
  border-bottom: 1px solid #F0F0F0;
  cursor: pointer;
  transition: background 0.2s;
}
.customer-item:hover, .customer-item.active { background: #F9F5ED; }
.customer-name { font-weight: bold; font-size: 0.95rem; }
.customer-preview { color: #888; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.customer-time { font-size: 0.75rem; color: #999; }
.unread { background: #C9A063; color: white; font-size: 0.7rem; padding: 2px 7px; border-radius: 10px; margin-left: 0.5rem; }
.quick-replies { padding: 0.5rem; background: #F9F9F9; border-top: 1px solid #E5E5E5; display: flex; flex-wrap: wrap; gap: 0.3rem; }
.quick-reply-toggle { background: none; border: 1px solid #C9A063; color: #C9A063; padding: 0.3rem 0.6rem; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
.quick-reply-btn { background: #FFF; border: 1px solid #DDD; padding: 0.3rem 0.6rem; border-radius: 20px; cursor: pointer; font-size: 0.8rem; display: none; }

/* === ì´ë¯¸ì§€ ì—…ë¡œë“œ ì§„í–‰ === */
.upload-progress {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 1.5rem 2rem;
  border-radius: 12px;
  z-index: 3000;
  display: none;
  text-align: center;
}
.upload-progress.active { display: block; }

/* === ëª¨ë°”ì¼ === */
.mobile-menu-btn { display: none !important; padding: 0.3rem 0.7rem; border: 1px solid #DDD; border-radius: 6px; background: white; cursor: pointer; font-size: 0.8rem; align-items: center; gap: 0.3rem; }

@media (max-width: 600px) {
  .mobile-menu-btn { display: inline-flex !important; }
  .input-area { padding-bottom: 2.5rem; }
  .staff-screen { grid-template-columns: 1fr; }
  .customer-list { display: none; }
  .menu-sidebar {
    display: none;
    position: fixed;
    top: 0; left: 0; bottom: 0;
    width: 85vw;
    height: 100%;
    height: 100dvh;
    z-index: 1000;
    box-shadow: 4px 0 20px rgba(0,0,0,0.15);
    padding-bottom: calc(2rem + env(safe-area-inset-bottom, 0px));
  }
  .menu-sidebar.mobile-open { display: flex; }
  .menu-overlay { height: 100dvh; }
}
@media (max-width: 768px) {
  .staff-screen { grid-template-columns: 1fr; }
  .customer-list { display: none; }
}
</style>
</head>
<body>

<!-- ë¡œë”© -->
<div class="screen active loading-screen" id="loadingScreen">
  <div class="logo">MALLANG</div>
  <div class="loading-spinner"></div>
</div>

<!-- ì–¸ì–´ ì„ íƒ -->
<div class="screen lang-screen" id="langScreen">
  <div class="logo">MALLANG</div>
  <div class="subtitle">Premium Beauty & Photo Studio</div>
  <div class="lang-grid">
    <button class="lang-btn" onclick="selectLang('ko')">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
    <button class="lang-btn" onclick="selectLang('en')">ğŸŒ English</button>
    <button class="lang-btn" onclick="selectLang('zh')">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
    <button class="lang-btn" onclick="selectLang('ja')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
    <button class="lang-btn" onclick="selectLang('th')">ğŸ‡¹ğŸ‡­ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</button>
    <button class="lang-btn" onclick="selectLang('vi')">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
  </div>
</div>

<!-- ë¡œê·¸ì¸ -->
<div class="screen auth-screen" id="loginScreen">
  <div class="logo" style="margin-bottom: 2rem;">MALLANG</div>
  <div class="auth-form">
    <h2>ë¡œê·¸ì¸ / Login</h2>
    <div class="auth-error" id="loginError"></div>
    <div class="form-group">
      <label>ì´ë©”ì¼ / Email</label>
      <input type="email" id="loginEmail" placeholder="email@example.com">
    </div>
    <div class="form-group">
      <label>ë¹„ë°€ë²ˆí˜¸ / Password</label>
      <input type="password" id="loginPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <button class="auth-btn" onclick="doLogin()">ë¡œê·¸ì¸ / Login</button>
    <div class="auth-switch">
      ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a onclick="showScreen('signupScreen')">íšŒì›ê°€ì… / Sign Up</a>
    </div>
  </div>
</div>

<!-- íšŒì›ê°€ì… -->
<div class="screen auth-screen" id="signupScreen">
  <div class="logo" style="margin-bottom: 2rem;">MALLANG</div>
  <div class="auth-form">
    <h2>íšŒì›ê°€ì… / Sign Up</h2>
    <div class="auth-error" id="signupError"></div>
    <div class="role-toggle" id="roleToggle">
      <button class="active" onclick="setRole('customer')">ğŸ‘¤ ê³ ê° / Customer</button>
      <button onclick="setRole('designer')">âœ‚ï¸ ë””ìì´ë„ˆ / Designer</button>
    </div>
    <div class="form-group">
      <label>ì´ë¦„ / Name *</label>
      <input type="text" id="signupName" placeholder="Hong Gildong">
    </div>
    <div class="designer-fields" id="designerFields">
      <div class="form-group">
        <label>í”„ë¡œí•„ ID * (ì˜ë¬¸, ì¹œêµ¬ ì¶”ê°€ì— ì‚¬ìš©)</label>
        <input type="text" id="signupProfileId" placeholder="Jina" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_]/g, '')">
      </div>
    </div>
    <div class="form-group">
      <label>ì´ë©”ì¼ / Email *</label>
      <input type="email" id="signupEmail" placeholder="email@example.com">
    </div>
    <div class="form-group">
      <label>ë¹„ë°€ë²ˆí˜¸ / Password *</label>
      <input type="password" id="signupPw" placeholder="6ì ì´ìƒ / 6+ characters">
    </div>
    <button class="auth-btn" onclick="doSignup()">íšŒì›ê°€ì… / Sign Up</button>
    <div class="auth-switch">
      ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a onclick="showScreen('loginScreen')">ë¡œê·¸ì¸ / Login</a>
    </div>
  </div>
</div>

<!-- ì±„íŒ… ëª©ë¡ -->
<div class="screen" id="chatListScreen">
  <div class="chatlist-header">
    <h2 id="chatListTitle">ì±„íŒ…</h2>
    <div class="chatlist-header-btns">
      <button onclick="showPriceMenu()" id="priceMenuBtn" style="display:none;">â˜° Price</button>
      <button onclick="showFriendModal()">+ ì¹œêµ¬ì¶”ê°€</button>
      <button onclick="doLogout()" style="font-size:0.8rem;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
  <div class="chatlist-items" id="chatListItems">
    <div class="no-chats">ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤</div>
  </div>
</div>

<!-- ì¹œêµ¬ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal-overlay" id="friendModal">
  <div class="modal-box" style="position:relative;">
    <button class="modal-close" onclick="closeFriendModal()">Ã—</button>
    <h3>ğŸ” ì¹œêµ¬ ì¶”ê°€ / Add Friend</h3>
    <p style="font-size:0.85rem; color:#888; margin-bottom:1rem; text-align:center;" id="friendSearchHint">ë””ìì´ë„ˆ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
    <input type="text" id="friendSearchInput" placeholder="ID ì…ë ¥ (ì˜ˆ: Jina)" oninput="this.value = this.value.replace(/[^a-zA-Z0-9_]/g, '')">
    <button class="gold-btn" onclick="searchFriend()">ê²€ìƒ‰ / Search</button>
    <div class="modal-result" id="friendResult"></div>
  </div>
</div>

<!-- ì±„íŒ…ë°© -->
<div class="screen" id="chatRoomScreen">
  <div class="chatroom-header">
    <button class="back-btn" onclick="backToChatList()">â†</button>
    <div class="chatroom-header-info">
      <h3 id="roomPartnerName">-</h3>
      <p id="roomPartnerInfo"></p>
    </div>
    <button class="mobile-menu-btn" id="roomPriceBtn" onclick="toggleMobileMenu()" style="display:none;">â˜° Price</button>
    <div class="lang-badge" id="roomPartnerLang"></div>
  </div>
  <!-- ë©”ë‰´ ì‚¬ì´ë“œë°” (ì˜¤ë²„ë ˆì´) -->
  <div class="menu-overlay" id="menuOverlay" onclick="closeMobileMenu()"></div>
  <div class="menu-sidebar" id="menuSidebar">
    <div class="menu-tabs">
      <div class="menu-tab active" onclick="showMenu('makeup')">ğŸ’„ ë©”ì´í¬ì—…</div>
      <div class="menu-tab" onclick="showMenu('hair')">ğŸ’‡ í—¤ì–´</div>
      <div class="menu-tab" onclick="showMenu('spa')">ğŸ§– ìŠ¤íŒŒ</div>
      <div class="menu-tab" onclick="showMenu('photo')">ğŸ“· í¬í† </div>
      <div class="menu-tab" onclick="showMenu('booking')">ğŸ“… ì˜ˆì•½í•˜ê¸°</div>
    </div>
    <div class="menu-content" id="menuContent"></div>
  </div>
  <div class="messages" id="chatMessages"></div>
  <div id="imgPreviewArea"></div>
  <div class="input-area">
    <button class="img-upload-btn" onclick="document.getElementById('imageInput').click()">ğŸ“·</button>
    <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="previewImage(event)">
    <textarea class="msg-input" id="chatInput" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <button class="send-btn" onclick="sendChatMsg()">ì „ì†¡</button>
  </div>
</div>

<!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì§„í–‰ -->
<div class="upload-progress" id="uploadProgress">ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...</div>

<!-- ìŠ¤íƒœí”„ í™”ë©´ -->
<div class="screen staff-screen" id="staffScreen">
  <div class="customer-list">
    <div class="list-header">
      <h2>ê³ ê° ëª©ë¡</h2>
      <input type="text" class="search-box" id="searchBox" placeholder="ê²€ìƒ‰..." oninput="searchCustomers()">
    </div>
    <div class="customer-items" id="customerList"></div>
  </div>
  <div style="display: flex; flex-direction: column; flex: 1;">
    <div class="chat-header" style="background:white;padding:1rem;border-bottom:1px solid #E5E5E5;display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h3 id="selectedName">ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”</h3>
        <p style="font-size:0.85rem;color:#666;" id="selectedInfo"></p>
      </div>
      <div class="lang-badge" id="selectedLang"></div>
    </div>
    <div class="messages" id="staffMsg"></div>
    <div class="quick-replies" id="quickReplies">
      <button class="quick-reply-toggle" onclick="toggleQuickReplies()">âš¡ ë¹ ë¥¸ë‹µë³€</button>
      <button class="quick-reply-btn" onclick="quickReply('address')">ğŸ“ ì£¼ì†Œ</button>
      <button class="quick-reply-btn" onclick="quickReply('confirmed')">âœ… ì˜ˆì•½ì™„ë£Œ</button>
      <button class="quick-reply-btn" onclick="quickReply('wechat')">ğŸ‡¨ğŸ‡³ ìœ„ì±—</button>
      <button class="quick-reply-btn" onclick="quickReply('paypal')">ğŸ’³ í˜ì´íŒ”</button>
      <button class="quick-reply-btn" onclick="quickReply('japan')">ğŸ‡¯ğŸ‡µ ì¼ë³¸</button>
    </div>
    <div class="input-area">
      <textarea class="msg-input" id="staffInput" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      <button class="send-btn" onclick="sendStaffMsg()">ì „ì†¡</button>
    </div>
  </div>
</div>

<script>
// ========================================
// Firebase ì´ˆê¸°í™”
// ========================================
const firebaseConfig = {
  apiKey: "AIzaSyCeouM3_9JCWaKTGEeQFrD3ZikAgpheJQ8",
  authDomain: "mallang-chat.firebaseapp.com",
  databaseURL: "https://mallang-chat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mallang-chat",
  storageBucket: "mallang-chat.firebasestorage.app",
  messagingSenderId: "224793274849",
  appId: "1:224793274849:web:d97f17bf3c410f0ed88aa0"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// ========================================
// ì „ì—­ ë³€ìˆ˜
// ========================================
let currentLang = 'ko';
let currentUser = null;
let currentUserData = null; // { name, role, profileId, lang, ... }
let currentChatId = null;
let currentChatType = null; // 'admin' or 'direct'
let currentChatPartner = null;
let selectedRoomId = null; // staff panel
let isSending = false;
let pendingImage = null; // ì—…ë¡œë“œí•  ì´ë¯¸ì§€ íŒŒì¼
let signupRole = 'customer';
let isSigningUp = false; // íšŒì›ê°€ì… ì§„í–‰ì¤‘ í”Œë˜ê·¸

// ========================================
// ë²ˆì—­ í…ìŠ¤íŠ¸
// ========================================
const T = {
  ko: { placeholder: 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...', subtitle: 'ìƒë‹´ì›ì´ ê³§ ì‘ë‹µí•©ë‹ˆë‹¤' },
  en: { placeholder: 'Type your message...', subtitle: 'Our team will reply shortly' },
  zh: { placeholder: 'è¯·è¾“å…¥æ¶ˆæ¯...', subtitle: 'æˆ‘ä»¬çš„å›¢é˜Ÿä¼šå°½å¿«å›å¤' },
  ja: { placeholder: 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...', subtitle: 'ã‚¹ã‚¿ãƒƒãƒ•ãŒã™ãã«å¯¾å¿œã—ã¾ã™' },
  th: { placeholder: 'à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡...', subtitle: 'à¸—à¸µà¸¡à¸‡à¸²à¸™à¸ˆà¸°à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¹ƒà¸™à¹€à¸£à¹‡à¸§à¹† à¸™à¸µà¹‰' },
  vi: { placeholder: 'Nháº­p tin nháº¯n...', subtitle: 'NhÃ¢n viÃªn sáº½ pháº£n há»“i sá»›m' }
};

// ========================================
// ì˜ˆì•½ í™•ì¸ ë©”ì‹œì§€ í…œí”Œë¦¿
// ========================================
const WECHAT_QR = 'data:image/jpeg;base64,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';

const quickConfirmed = `[CENTER]â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”[/CENTER]

[CENTER]âœ… ì˜ˆì•½ ì™„ë£Œ ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…[/CENTER]

[CENTER]ê¼­ !! ì½ì–´ì£¼ì„¸ìš” !![/CENTER]

**1. ì˜ˆì•½ ì‹œê°„ 10ë¶„ ì´ìƒ ì§€ê° ì‹œ ìë™ ì·¨ì†Œë˜ë©° ì˜ˆì•½ê¸ˆì€ í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**
2. ì˜ˆì•½ ë³€ê²½Â·ì·¨ì†ŒëŠ” ì˜ˆì•½ì¼ 2ì¼ ì „ ì˜¤í›„ 6ì‹œ(KST)ê¹Œì§€ ê°€ëŠ¥í•˜ë©°, ì´í›„ì—ëŠ” í™˜ë¶ˆì´ ë¶ˆê°€í•©ë‹ˆë‹¤.
3. í—¤ì–´ ìŠ¤íƒ€ì¼ë§ì„ ì˜ˆì•½í•˜ì‹  ë¶„ì€ ë‹¹ì¼ ì˜¤ì „ ìˆ™ì†Œì—ì„œ ìƒ´í‘¸ í›„ ë¦°ìŠ¤ë‚˜ í—¤ì–´ì œí’ˆ ì‚¬ìš©í•˜ì§€ ë§ê³  ë°©ë¬¸í•´ì£¼ì„¸ìš”(ì»¤íŠ¸ ì˜ˆì•½ì€ ìƒ´í‘¸ í¬í•¨ / ì˜¤ì „ 11ì‹œ ì´ì „ ìƒ´í‘¸ ë¶ˆê°€)
4. ë©”ì´í¬ì—… ì˜ˆì•½ ê³ ê°ë‹˜ì€ ê¸°ì´ˆ ì¼€ì–´ë§Œ í•˜ê³  ë¯¼ë‚¯ìœ¼ë¡œ ë°©ë¬¸í•´ ì£¼ì„¸ìš”.
5. ì½˜íƒíŠ¸ë Œì¦ˆëŠ” ë©”ì´í¬ì—… ì‹œì‘ ì „ì— ë°˜ë“œì‹œ ì°©ìš©ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.
6. í˜„ì¥ ìƒí™©ì— ë”°ë¼ ë¶ˆê°€í”¼í•œ ëŒ€ê¸° ì‹œê°„ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ëŠ¦ê²Œ ì˜¤ì‹œë©´ ë‹¤ë¥¸ ì˜ˆì•½ ì†ë‹˜ë“¤ì—ê²Œ ë§‰ëŒ€í•œ í”¼í•´ë¥¼ ì¤„ ìˆ˜ ìˆìœ¼ë‹ˆ ì œë°œ ì˜ˆì•½ ì‹œê°„ ì•ˆì— ë„ì°©í•´ ì£¼ì‹œê¸¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤**

ì˜ˆì•½ í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ™`;

// ========================================
// í™”ë©´ ì „í™˜
// ========================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ========================================
// ì—­í•  ì„ íƒ (íšŒì›ê°€ì…)
// ========================================
function setRole(role) {
  signupRole = role;
  document.querySelectorAll('#roleToggle button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  const df = document.getElementById('designerFields');
  if (role === 'designer') {
    df.classList.add('show');
    document.getElementById('friendSearchHint').textContent = 'ê³ ê° IDë¥¼ ì…ë ¥í•˜ì„¸ìš”';
  } else {
    df.classList.remove('show');
    document.getElementById('friendSearchHint').textContent = 'ë””ìì´ë„ˆ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”';
  }
}

// ========================================
// ì–¸ì–´ ì„ íƒ (ê³ ê°ìš©)
// ========================================
function selectLang(lang) {
  currentLang = lang;
  if (currentUser && currentUserData) {
    // ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœ
    if (currentUserData.role !== 'designer') {
      initAdminRoom();
    }
    loadChatList();
    showScreen('chatListScreen');
  } else {
    showScreen('loginScreen');
  }
}

// ========================================
// Auth ìƒíƒœ ê°ì§€
// ========================================
const isStaffMode = new URLSearchParams(window.location.search).has('staff');

auth.onAuthStateChanged(async (user) => {
  if (isStaffMode) {
    goStaff();
    return;
  }
  if (isSigningUp) return; // íšŒì›ê°€ì… ì¤‘ì—ëŠ” ë¬´ì‹œ
  if (user) {
    currentUser = user;
    const snap = await db.ref('users/' + user.uid).once('value');
    currentUserData = snap.val();
    
    if (currentUserData) {
      currentLang = currentUserData.lang || 'en';
      
      // ê³ ê°ì´ë©´ ê´€ë¦¬ì ì±„íŒ…ë°© í™•ì¸/ìƒì„±
      if (currentUserData.role !== 'designer') {
        if (!currentUserData.adminRoomId) {
          await initAdminRoom();
        }
      }
      
      // ì±„íŒ… ëª©ë¡ìœ¼ë¡œ
      loadChatList();
      showScreen('chatListScreen');
      
      // ê³ ê°ì´ë©´ Price ë²„íŠ¼ í‘œì‹œ
      if (currentUserData.role !== 'designer') {
        document.getElementById('priceMenuBtn').style.display = 'inline-block';
      }
    } else {
      showScreen('langScreen');
    }
  } else {
    currentUser = null;
    currentUserData = null;
    showScreen('langScreen');
  }
});

// ========================================
// íšŒì›ê°€ì…
// ========================================
async function doSignup() {
  const name = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const pw = document.getElementById('signupPw').value;
  const profileId = document.getElementById('signupProfileId').value.trim();
  const errEl = document.getElementById('signupError');
  
  errEl.style.display = 'none';
  
  if (!name || !email || !pw) {
    errEl.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” / Please fill in all fields';
    errEl.style.display = 'block';
    return;
  }
  
  if (signupRole === 'designer' && !profileId) {
    errEl.textContent = 'í”„ë¡œí•„ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
    errEl.style.display = 'block';
    return;
  }
  
  // ë””ìì´ë„ˆ í”„ë¡œí•„ ID ì¤‘ë³µ í™•ì¸
  if (signupRole === 'designer') {
    const idCheck = await db.ref('profileIds/' + profileId.toLowerCase()).once('value');
    if (idCheck.exists()) {
      errEl.textContent = 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ IDì…ë‹ˆë‹¤ / ID already taken';
      errEl.style.display = 'block';
      return;
    }
  }
  
  try {
    isSigningUp = true;
    const cred = await auth.createUserWithEmailAndPassword(email, pw);
    await cred.user.updateProfile({ displayName: name });
    
    const userData = {
      name: name,
      email: email,
      role: signupRole,
      lang: signupRole === 'designer' ? 'ko' : currentLang,
      createdAt: Date.now()
    };
    
    if (signupRole === 'designer') {
      userData.profileId = profileId;
      // í”„ë¡œí•„ ID ì¸ë±ìŠ¤ ì €ì¥
      await db.ref('profileIds/' + profileId.toLowerCase()).set(cred.user.uid);
    } else {
      // ê³ ê°ì€ uid ì• 8ìë¦¬ë¥¼ profileIdë¡œ
      userData.profileId = cred.user.uid.substring(0, 8);
    }
    
    await db.ref('users/' + cred.user.uid).set(userData);
    
    // ìˆ˜ë™ìœ¼ë¡œ ìƒíƒœ ì„¤ì • í›„ í™”ë©´ ì´ë™
    currentUser = cred.user;
    currentUserData = userData;
    
    // ê³ ê°ì´ë©´ ê´€ë¦¬ì ì±„íŒ…ë°© ìƒì„±
    if (signupRole !== 'designer') {
      await initAdminRoom();
    }
    
    isSigningUp = false;
    loadChatList();
    showScreen('chatListScreen');
    
    if (signupRole !== 'designer') {
      document.getElementById('priceMenuBtn').style.display = 'inline-block';
    }
    
  } catch (error) {
    isSigningUp = false;
    errEl.textContent = getAuthErrorMsg(error.code);
    errEl.style.display = 'block';
  }
}

// ========================================
// ë¡œê·¸ì¸
// ========================================
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pw = document.getElementById('loginPw').value;
  const errEl = document.getElementById('loginError');
  
  errEl.style.display = 'none';
  if (!email || !pw) {
    errEl.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
    errEl.style.display = 'block';
    return;
  }
  
  try {
    await auth.signInWithEmailAndPassword(email, pw);
  } catch (error) {
    errEl.textContent = getAuthErrorMsg(error.code);
    errEl.style.display = 'block';
  }
}

// ========================================
// ë¡œê·¸ì•„ì›ƒ
// ========================================
async function doLogout() {
  if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  currentUser = null;
  currentUserData = null;
  currentChatId = null;
  await auth.signOut();
  showScreen('langScreen');
}

// ========================================
// ê´€ë¦¬ì ì±„íŒ…ë°© ìƒì„± (ê³ ê°ìš©, ê¸°ì¡´ í˜¸í™˜)
// ========================================
async function initAdminRoom() {
  if (!currentUser) return;
  const uid = currentUser.uid;
  const roomId = 'room_' + uid;
  
  const snap = await db.ref('rooms/' + roomId).once('value');
  if (!snap.exists()) {
    await db.ref('rooms/' + roomId).set({
      userName: currentUser.displayName || 'Guest',
      userEmail: currentUser.email || '',
      userLang: currentLang,
      userId: uid,
      lastMessage: '',
      lastMessageTime: Date.now(),
      unreadCount: 0
    });
  }
  
  await db.ref('users/' + uid).update({ adminRoomId: roomId, lang: currentLang });
  if (currentUserData) currentUserData.adminRoomId = roomId;
}

// ========================================
// ì±„íŒ… ëª©ë¡
// ========================================
function loadChatList() {
  if (!currentUser) return;
  const uid = currentUser.uid;
  const container = document.getElementById('chatListItems');
  
  // íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
  document.getElementById('chatListTitle').textContent = 
    currentUserData?.role === 'designer' ? 'ğŸ’¬ ì±„íŒ…' : 'ğŸ’¬ ì±„íŒ…';
  
  // 1:1 ì±„íŒ… ëª©ë¡ ë¦¬ìŠ¤ë‹
  db.ref('userChats/' + uid).on('value', async (snap) => {
    const chats = snap.val() || {};
    let items = [];
    
    // ê³ ê°ì´ë©´ ê´€ë¦¬ì ì±„íŒ… ì¶”ê°€ (ë§¨ ìœ„)
    if (currentUserData?.role !== 'designer' && currentUserData?.adminRoomId) {
      const adminSnap = await db.ref('rooms/' + currentUserData.adminRoomId).once('value');
      const adminRoom = adminSnap.val();
      if (adminRoom) {
        items.push({
          id: currentUserData.adminRoomId,
          type: 'admin',
          name: 'MALLANG',
          avatar: 'M',
          avatarClass: 'admin',
          preview: adminRoom.lastMessage || 'ìƒˆë¡œìš´ ëŒ€í™”',
          time: adminRoom.lastMessageTime || 0,
          unread: 0
        });
      }
    }
    
    // 1:1 ì±„íŒ…ë“¤
    const chatEntries = Object.entries(chats);
    for (const [chatId, chatInfo] of chatEntries) {
      const partnerUid = chatInfo.partnerUid;
      const partnerSnap = await db.ref('users/' + partnerUid).once('value');
      const partner = partnerSnap.val();
      if (!partner) continue;
      
      const chatSnap = await db.ref('chats/' + chatId).once('value');
      const chatData = chatSnap.val();
      
      items.push({
        id: chatId,
        type: 'direct',
        name: partner.name || 'Unknown',
        partnerUid: partnerUid,
        avatar: (partner.name || '?')[0].toUpperCase(),
        avatarClass: partner.role === 'designer' ? 'designer' : '',
        preview: chatData?.lastMessage || 'ìƒˆë¡œìš´ ëŒ€í™”',
        time: chatData?.lastMessageTime || 0,
        unread: chatData?.['unread_' + uid] || 0,
        lang: partner.lang
      });
    }
    
    // ì‹œê°„ìˆœ ì •ë ¬ (ê´€ë¦¬ì ì œì™¸)
    const adminItem = items.find(i => i.type === 'admin');
    const directItems = items.filter(i => i.type !== 'admin')
      .sort((a, b) => b.time - a.time);
    items = adminItem ? [adminItem, ...directItems] : directItems;
    
    if (items.length === 0) {
      container.innerHTML = '<div class="no-chats">ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤<br><br>+ ì¹œêµ¬ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ<br>ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>';
      return;
    }
    
    container.innerHTML = items.map(item => `
      <div class="chatlist-item" onclick="openChat('${item.id}', '${item.type}', '${item.partnerUid || ''}')">
        <div class="chatlist-avatar ${item.avatarClass}">${item.avatar}</div>
        <div class="chatlist-info">
          <div class="chatlist-name">
            ${escapeHtml(item.name)}
            ${item.lang ? '<span style="font-size:0.75rem;color:#999;">' + getFlag(item.lang) + '</span>' : ''}
          </div>
          <div class="chatlist-preview">${previewText(item.preview)}</div>
        </div>
        <div class="chatlist-meta">
          <div class="chatlist-time">${formatTime(item.time)}</div>
          ${item.unread > 0 ? '<div class="chatlist-unread">' + item.unread + '</div>' : ''}
        </div>
      </div>
    `).join('');
  });
  
  // ê´€ë¦¬ì ì±„íŒ…ë°© ë³€ê²½ ê°ì§€ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
  if (currentUserData?.adminRoomId) {
    db.ref('rooms/' + currentUserData.adminRoomId).on('value', () => {
      // chatlistê°€ ì—…ë°ì´íŠ¸ë˜ë„ë¡ userChats íŠ¸ë¦¬ê±°
      db.ref('userChats/' + uid).once('value'); // ë¦¬í”„ë ˆì‹œ íŠ¸ë¦¬ê±°
    });
  }
}

// ========================================
// ì±„íŒ…ë°© ì—´ê¸°
// ========================================
function openChat(chatId, type, partnerUid) {
  currentChatId = chatId;
  currentChatType = type;
  currentChatPartner = partnerUid;
  
  // ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
  document.getElementById('chatMessages').innerHTML = '';
  document.getElementById('imgPreviewArea').innerHTML = '';
  pendingImage = null;
  
  if (type === 'admin') {
    // ê´€ë¦¬ì ì±„íŒ…
    document.getElementById('roomPartnerName').textContent = 'MALLANG';
    document.getElementById('roomPartnerInfo').textContent = T[currentLang]?.subtitle || T.en.subtitle;
    document.getElementById('roomPartnerLang').textContent = '';
    document.getElementById('roomPriceBtn').style.display = 'inline-flex';
    document.getElementById('chatInput').placeholder = T[currentLang]?.placeholder || T.en.placeholder;
    
    listenAdminMessages();
  } else {
    // 1:1 ì±„íŒ…
    document.getElementById('roomPriceBtn').style.display = 'none';
    document.getElementById('chatInput').placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
    
    db.ref('users/' + partnerUid).once('value', snap => {
      const partner = snap.val();
      if (partner) {
        document.getElementById('roomPartnerName').textContent = partner.name;
        document.getElementById('roomPartnerInfo').textContent = partner.role === 'designer' ? 'âœ‚ï¸ Designer' : 'ğŸ‘¤ Customer';
        document.getElementById('roomPartnerLang').textContent = getFlag(partner.lang) + ' ' + (partner.lang || '').toUpperCase();
      }
    });
    
    // ì½ìŒ ì²˜ë¦¬
    if (currentUser) {
      db.ref('chats/' + chatId + '/unread_' + currentUser.uid).set(0);
    }
    
    listenDirectMessages();
  }
  
  showScreen('chatRoomScreen');
}

function backToChatList() {
  // ë¦¬ìŠ¤ë„ˆ í•´ì œ
  if (currentChatId) {
    if (currentChatType === 'admin') {
      db.ref('rooms/' + currentChatId + '/messages').off();
    } else {
      db.ref('chats/' + currentChatId + '/messages').off();
    }
  }
  currentChatId = null;
  currentChatType = null;
  showScreen('chatListScreen');
}

// ========================================
// ê´€ë¦¬ì ì±„íŒ… ë©”ì‹œì§€ (ê¸°ì¡´ rooms êµ¬ì¡°)
// ========================================
function listenAdminMessages() {
  const container = document.getElementById('chatMessages');
  container.innerHTML = '';
  
  db.ref('rooms/' + currentChatId + '/messages').off();
  db.ref('rooms/' + currentChatId + '/messages').on('child_added', snap => {
    const msg = snap.val();
    if (!msg || msg.deleted) return;
    appendMessage(container, msg.text, msg.imageUrl, !msg.isStaff, msg.timestamp, snap.key);
  });
}

// ========================================
// 1:1 ì±„íŒ… ë©”ì‹œì§€
// ========================================
function listenDirectMessages() {
  const container = document.getElementById('chatMessages');
  container.innerHTML = '';
  
  db.ref('chats/' + currentChatId + '/messages').off();
  db.ref('chats/' + currentChatId + '/messages').on('child_added', snap => {
    const msg = snap.val();
    if (!msg || msg.deleted) return;
    const isMine = msg.sender === currentUser.uid;
    appendMessage(container, msg.text, msg.imageUrl, isMine, msg.timestamp, snap.key);
  });
}

// ========================================
// ë©”ì‹œì§€ UI ì¶”ê°€
// ========================================
function appendMessage(container, text, imageUrl, isMine, timestamp, msgKey) {
  const div = document.createElement('div');
  div.className = 'message ' + (isMine ? 'from-me' : 'from-them');
  div.id = 'msg-' + msgKey;
  
  let content = '';
  if (imageUrl) {
    content += `<img src="${imageUrl}" class="msg-img" onclick="window.open('${imageUrl}','_blank')">`;
  }
  if (text) {
    content += renderMessage(text);
  }
  
  div.innerHTML = `
    <div class="msg-bubble">${content}</div>
    <div class="msg-time">${formatTime(timestamp)}</div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// ========================================
// ë©”ì‹œì§€ ì „ì†¡
// ========================================
async function sendChatMsg() {
  if (isSending) return;
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  
  if (!text && !pendingImage) return;
  if (!currentChatId) return;
  
  isSending = true;
  input.value = '';
  input.style.height = 'auto';
  
  let imageUrl = null;
  
  // ì´ë¯¸ì§€ ì—…ë¡œë“œ
  if (pendingImage) {
    document.getElementById('uploadProgress').classList.add('active');
    try {
      const fileName = Date.now() + '_' + pendingImage.name;
      const ref = storage.ref('chat-images/' + currentChatId + '/' + fileName);
      const snapshot = await ref.put(pendingImage);
      imageUrl = await snapshot.ref.getDownloadURL();
    } catch (e) {
      alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
      isSending = false;
      document.getElementById('uploadProgress').classList.remove('active');
      return;
    }
    document.getElementById('uploadProgress').classList.remove('active');
    pendingImage = null;
    document.getElementById('imgPreviewArea').innerHTML = '';
  }
  
  try {
    if (currentChatType === 'admin') {
      // ê´€ë¦¬ì ì±„íŒ… (ê¸°ì¡´ êµ¬ì¡°)
      await db.ref('rooms/' + currentChatId + '/messages').push({
        text: text || '', imageUrl: imageUrl || null, isStaff: false, timestamp: Date.now()
      });
      await db.ref('rooms/' + currentChatId).update({
        lastMessage: imageUrl ? 'ğŸ“· ì‚¬ì§„' : text,
        lastMessageTime: Date.now(),
        unreadCount: firebase.database.ServerValue.increment(1)
      });
    } else {
      // 1:1 ì±„íŒ…
      await db.ref('chats/' + currentChatId + '/messages').push({
        sender: currentUser.uid,
        text: text || '',
        imageUrl: imageUrl || null,
        timestamp: Date.now()
      });
      const lastMsg = imageUrl ? 'ğŸ“· ì‚¬ì§„' : text;
      const updates = {
        lastMessage: lastMsg,
        lastMessageTime: Date.now()
      };
      updates['unread_' + currentChatPartner] = firebase.database.ServerValue.increment(1);
      await db.ref('chats/' + currentChatId).update(updates);
    }
  } catch (error) {
    alert('ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
  } finally { isSending = false; }
}

// ========================================
// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
// ========================================
function previewImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // 10MB ì œí•œ
  if (file.size > 10 * 1024 * 1024) {
    alert('10MB ì´í•˜ì˜ ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
    return;
  }
  
  pendingImage = file;
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('imgPreviewArea').innerHTML = `
      <div class="img-preview" style="padding: 0.5rem 1rem;">
        <img src="${e.target.result}">
        <button class="img-preview-remove" onclick="cancelImage()">âœ•</button>
      </div>
    `;
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function cancelImage() {
  pendingImage = null;
  document.getElementById('imgPreviewArea').innerHTML = '';
}

// ========================================
// ì¹œêµ¬ ì¶”ê°€
// ========================================
function showFriendModal() {
  document.getElementById('friendModal').classList.add('active');
  document.getElementById('friendSearchInput').value = '';
  document.getElementById('friendResult').className = 'modal-result';
  document.getElementById('friendResult').innerHTML = '';
  
  // íŒíŠ¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  if (currentUserData?.role === 'designer') {
    document.getElementById('friendSearchHint').textContent = 'ê³ ê° ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”';
    document.getElementById('friendSearchInput').placeholder = 'email@example.com';
  } else {
    document.getElementById('friendSearchHint').textContent = 'ë””ìì´ë„ˆ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”';
    document.getElementById('friendSearchInput').placeholder = 'ID ì…ë ¥ (ì˜ˆ: Jina)';
  }
}

function closeFriendModal() {
  document.getElementById('friendModal').classList.remove('active');
}

async function searchFriend() {
  const query = document.getElementById('friendSearchInput').value.trim();
  const resultEl = document.getElementById('friendResult');
  
  if (!query) return;
  
  let foundUid = null;
  let foundUser = null;
  
  if (currentUserData?.role === 'designer') {
    // ë””ìì´ë„ˆëŠ” ê³ ê° ì´ë©”ì¼ë¡œ ê²€ìƒ‰
    const snap = await db.ref('users').orderByChild('email').equalTo(query).once('value');
    const users = snap.val();
    if (users) {
      const entries = Object.entries(users);
      for (const [uid, user] of entries) {
        if (user.role !== 'designer') {
          foundUid = uid;
          foundUser = user;
          break;
        }
      }
    }
  } else {
    // ê³ ê°ì€ ë””ìì´ë„ˆ profileIdë¡œ ê²€ìƒ‰
    const uidSnap = await db.ref('profileIds/' + query.toLowerCase()).once('value');
    if (uidSnap.exists()) {
      foundUid = uidSnap.val();
      const userSnap = await db.ref('users/' + foundUid).once('value');
      foundUser = userSnap.val();
      if (foundUser && foundUser.role !== 'designer') {
        foundUser = null; // ë””ìì´ë„ˆë§Œ
      }
    }
  }
  
  if (foundUser && foundUid !== currentUser.uid) {
    // ì´ë¯¸ ì¹œêµ¬ì¸ì§€ í™•ì¸
    const friendCheck = await db.ref('friends/' + currentUser.uid + '/' + foundUid).once('value');
    const alreadyFriend = friendCheck.exists();
    
    resultEl.className = 'modal-result found';
    resultEl.innerHTML = `
      <div class="modal-result-user">
        <div class="chatlist-avatar ${foundUser.role === 'designer' ? 'designer' : ''}" style="width:40px;height:40px;font-size:1rem;">
          ${(foundUser.name || '?')[0].toUpperCase()}
        </div>
        <div style="flex:1;">
          <div style="font-weight:600;">${escapeHtml(foundUser.name)}</div>
          <div style="font-size:0.8rem;color:#888;">${foundUser.role === 'designer' ? 'âœ‚ï¸ Designer' : 'ğŸ‘¤ Customer'} ${foundUser.profileId ? 'Â· ' + foundUser.profileId : ''}</div>
        </div>
        ${alreadyFriend ? 
          '<span style="color:#888;font-size:0.85rem;">ì´ë¯¸ ì¹œêµ¬</span>' : 
          `<button class="gold-btn" style="width:auto;padding:0.4rem 1rem;" onclick="addFriend('${foundUid}')">ì¶”ê°€</button>`
        }
      </div>
    `;
  } else {
    resultEl.className = 'modal-result not-found';
    resultEl.innerHTML = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤';
  }
}

async function addFriend(friendUid) {
  if (!currentUser) return;
  const uid = currentUser.uid;
  
  try {
    // ì–‘ë°©í–¥ ì¹œêµ¬ ë“±ë¡
    await db.ref('friends/' + uid + '/' + friendUid).set({ since: Date.now() });
    await db.ref('friends/' + friendUid + '/' + uid).set({ since: Date.now() });
    
    // ì±„íŒ…ë°© ìƒì„±
    const chatId = [uid, friendUid].sort().join('_');
    
    const chatSnap = await db.ref('chats/' + chatId).once('value');
    if (!chatSnap.exists()) {
      await db.ref('chats/' + chatId).set({
        participants: { [uid]: true, [friendUid]: true },
        lastMessage: '',
        lastMessageTime: Date.now(),
        ['unread_' + uid]: 0,
        ['unread_' + friendUid]: 0
      });
    }
    
    // ì–‘ìª½ ìœ ì €ì˜ ì±„íŒ… ëª©ë¡ì— ì¶”ê°€
    await db.ref('userChats/' + uid + '/' + chatId).set({ partnerUid: friendUid });
    await db.ref('userChats/' + friendUid + '/' + chatId).set({ partnerUid: uid });
    
    closeFriendModal();
    alert('ì¹œêµ¬ ì¶”ê°€ ì™„ë£Œ! âœ…');
    
  } catch (error) {
    alert('ì¹œêµ¬ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
  }
}

// ========================================
// ìŠ¤íƒœí”„ ê´€ë¦¬ì íŒ¨ë„ (ê¸°ì¡´ ìœ ì§€)
// ========================================
const STAFF_PW = 'mallang1347';

function goStaff() {
  const pw = prompt('ìŠ¤íƒœí”„ ë¹„ë°€ë²ˆí˜¸:');
  if (pw === STAFF_PW) {
    showScreen('staffScreen');
    loadCustomerList();
  } else if (pw !== null) {
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
  }
}

function loadCustomerList() {
  db.ref('rooms').on('value', snap => {
    const rooms = snap.val();
    if (!rooms) {
      document.getElementById('customerList').innerHTML = '<div style="padding:2rem;text-align:center;color:#999;">ì•„ì§ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }
    const html = Object.entries(rooms)
      .sort((a,b) => b[1].lastMessageTime - a[1].lastMessageTime)
      .map(([id, r]) => `
        <div class="customer-item ${selectedRoomId === id ? 'active' : ''}" onclick="selectCustomer('${id}')">
          <div class="customer-name">
            ${r.userName || 'ì´ë¦„ ì—†ìŒ'}
            ${r.unreadCount > 0 ? `<span class="unread">${r.unreadCount}</span>` : ''}
          </div>
          <div class="customer-preview">${previewText(r.lastMessage)}</div>
          <div class="customer-time">${formatTime(r.lastMessageTime)}</div>
        </div>
      `).join('');
    document.getElementById('customerList').innerHTML = html;
  });
}

function selectCustomer(roomId) {
  selectedRoomId = roomId;
  db.ref('rooms/' + roomId).once('value', snap => {
    const r = snap.val();
    if (!r) return;
    document.getElementById('selectedName').textContent = r.userName || 'ì´ë¦„ ì—†ìŒ';
    document.getElementById('selectedInfo').textContent = r.userEmail || '';
    document.getElementById('selectedLang').textContent = getFlag(r.userLang) + ' ' + (r.userLang || 'EN').toUpperCase();
  });
  db.ref('rooms/' + roomId + '/unreadCount').set(0);
  listenStaffMessages(roomId);
}

function listenStaffMessages(roomId) {
  const container = document.getElementById('staffMsg');
  container.innerHTML = '';
  
  db.ref('rooms/' + roomId + '/messages').off();
  db.ref('rooms/' + roomId + '/messages').on('child_added', snap => {
    const msg = snap.val();
    if (!msg) return;
    const msgKey = snap.key;
    const div = document.createElement('div');
    div.id = 'msg-' + msgKey;
    
    if (msg.deleted) {
      div.style.display = 'none';
      container.appendChild(div);
      return;
    }
    
    div.className = 'message ' + (msg.isStaff ? 'from-me' : 'from-them');
    const deleteBtn = msg.isStaff ? `<button class="msg-delete" onclick="deleteMessage('${roomId}','${msgKey}')" title="ì‚­ì œ">âœ•</button>` : '';
    
    let content = '';
    if (msg.imageUrl) content += `<img src="${msg.imageUrl}" class="msg-img" onclick="window.open('${msg.imageUrl}','_blank')">`;
    if (msg.text) content += renderMessage(msg.text);
    
    div.innerHTML = `
      <div class="msg-bubble" style="position:relative;">${deleteBtn}${content}</div>
      <div class="msg-time">${formatTime(msg.timestamp)}</div>
    `;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  });
  
  db.ref('rooms/' + roomId + '/messages').on('child_changed', snap => {
    const msg = snap.val();
    const div = document.getElementById('msg-' + snap.key);
    if (div && msg && msg.deleted) div.style.display = 'none';
  });
}

async function deleteMessage(roomId, msgKey) {
  if (!confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await db.ref('rooms/' + roomId + '/messages/' + msgKey).update({ deleted: true, text: '' });
}

async function sendStaffMsg() {
  if (isSending) return;
  const input = document.getElementById('staffInput');
  const text = input.value.trim();
  if (!text || !selectedRoomId) { alert('ê³ ê°ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!'); return; }
  
  isSending = true;
  input.value = '';
  input.style.height = 'auto';
  
  try {
    await db.ref('rooms/' + selectedRoomId + '/messages').push({
      text: text, isStaff: true, timestamp: Date.now()
    });
    await db.ref('rooms/' + selectedRoomId).update({
      lastMessage: text, lastMessageTime: Date.now()
    });
  } catch (error) { alert('ì „ì†¡ ì‹¤íŒ¨: ' + error.message); }
  finally { isSending = false; }
}

// ë¹ ë¥¸ë‹µë³€
function toggleQuickReplies() {
  document.querySelectorAll('#quickReplies .quick-reply-btn').forEach(btn => {
    btn.style.display = btn.style.display === 'none' ? 'inline-block' : 'none';
  });
}

function quickReply(key) {
  if (!selectedRoomId) { alert('ê³ ê°ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!'); return; }
  const input = document.getElementById('staffInput');
  
  if (key === 'paypal') {
    const won = prompt('ì˜ˆì•½ê¸ˆ (ì›/KRW):');
    if (!won) return;
    const w = parseInt(won.replace(/,/g,''));
    const usd = (w / 1350).toFixed(1);
    input.value = `ğŸ’³ PayPal Payment\n\ndeposit : ${w.toLocaleString()} won / USD ${usd}\n(Please make the payment in USD.)\n\nhttps://www.paypal.com/ncp/payment/LHVBDE7UWNLD4\n\nâ€¢ Total Amount â€“ Deposit = On-site Payment\nâ€¢ Your reservation will be confirmed after the deposit payment.\nâ€¢ If not completed within 30 minutes, reservation will be canceled.\nâ€¢ Cancellations available until 6:00 PM (KST), two days before.\nâ€¢ Please send a screenshot after completing payment.`;
  } else if (key === 'wechat') {
    const won = prompt('é¢„çº¦é‡‘ (éŸ©å…ƒ/KRW):');
    if (!won) return;
    const w = parseInt(won.replace(/,/g,''));
    input.value = `[WECHAT_QR]\n\né¢„çº¦é‡‘ï¼š${w.toLocaleString()} éŸ©å…ƒ\n\nâ€¢ æ€»ä»˜æ¬¾é‡‘é¢ â€“ é¢„çº¦é‡‘ = ç°åœºæ”¯ä»˜\nâ€¢ æ”¯ä»˜é¢„çº¦é‡‘åï¼Œé¢„çº¦å³ç¡®è®¤å®Œæˆã€‚\nâ€¢ 30åˆ†é’Ÿå†…æœªå®Œæˆä»˜æ¬¾ï¼Œé¢„çº¦å°†è‡ªåŠ¨å–æ¶ˆã€‚\nâ€¢ å¯åœ¨é¢„çº¦æ—¥å‰2å¤©ä¸‹åˆ6ç‚¹å‰å–æ¶ˆå¹¶é€€æ¬¾ã€‚\nâ€¢ ä»˜æ¬¾å®Œæˆåï¼Œè¯·å‘é€æˆªå›¾ã€‚`;
  } else if (key === 'japan') {
    const won = prompt('äºˆç´„é‡‘ (ã‚¦ã‚©ãƒ³/KRW):');
    if (!won) return;
    const w = parseInt(won.replace(/,/g,''));
    const jpy = Math.ceil(w / 8.9 / 100) * 100;
    input.value = `ğŸ‡¯ğŸ‡µ äºˆç´„é‡‘ã®ã”æ¡ˆå†…\n\näºˆç´„é‡‘ : ${w.toLocaleString()} won ( ${jpy.toLocaleString()} å†† )\n\npaypayéŠ€è¡Œ(0033)\nã¯ã‚„ã¶ã•æ”¯åº—(003)\næ™®é€š7862427\nã‚­ãƒ ã‚¸ãƒ§ãƒ³ãƒ’\n\n* æ”¯æ‰•ã„å¾Œã®è©³ç´°(ç”»é¢)ã‚’ãŠé¡˜ã„ã—ã¾ã™ *\n\nâ€¢ ç·ãŠæ”¯æ‰•ã„é‡‘é¡ âˆ’ äºˆç´„é‡‘ ï¼ å½“æ—¥ç¾åœ°æ±ºæ¸ˆ\nâ€¢ äºˆç´„é‡‘ã®ãŠæ”¯æ‰•ã„å®Œäº†å¾Œã€äºˆç´„ãŒç¢ºå®šã¨ãªã‚Šã¾ã™ã€‚\nâ€¢ 30åˆ†ä»¥å†…ã«ãŠæ”¯æ‰•ã„ãŒç¢ºèªã§ããªã„å ´åˆã€äºˆç´„ã¯è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ãªã‚Šã¾ã™ã€‚\nâ€¢ ã”äºˆç´„æ—¥ã®2æ—¥å‰18:00(KST)ã¾ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½ã§ã™ã€‚`;
  } else if (key === 'address') {
    input.value = `ğŸ“ [ Address ]\n21-3, Seolleung-ro 161-gil, Gangnam-gu, Seoul\n(ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì‹ ì‚¬ë™ 662-10)\n\n[DIRECTIONS_BTN]`;
  } else if (key === 'confirmed') {
    const info = prompt('ê³ ê° ì˜ˆì•½ ì •ë³´ ì…ë ¥\n(ì˜ˆ: 3/15(í† ) 14:00 / Yuki / ë©”ì´í¬ì—…A+í—¤ì–´B)');
    if (!info) return;
    input.value = info + '\n' + quickConfirmed;
  }
  input.focus();
  autoResize(input);
}

function searchCustomers() {
  const q = document.getElementById('searchBox').value.toLowerCase();
  document.querySelectorAll('.customer-item').forEach(item => {
    item.style.display = item.textContent.toLowerCase().includes(q) ? 'block' : 'none';
  });
}

// ========================================
// ë©”ë‰´/ê°€ê²©í‘œ ì‚¬ì´ë“œë°”
// ========================================
const menuData = {
  makeup: `<h4>ğŸ’„ [ Lady - Make up ]</h4>
<div class="price-row"><span>A (daily)</span><span>â‚©100,000</span></div>
<div class="price-row"><span>B (idol, photo shoot)</span><span>â‚©110,000</span></div>
<h4>ğŸ¤µ [ Man - Make up ]</h4>
<div class="price-row"><span>A (daily)</span><span>â‚©60,000</span></div>
<div class="price-row"><span>B (idol, photo shoot)</span><span>â‚©90,000</span></div>
<h4>ğŸ“š [ Make up Lesson ]</h4>
<div class="price-row"><span>90 min</span><span>â‚©350,000</span></div>
<div class="divider"></div>
<h4>âœ¨ Hair Styling (Setting)</h4>
<p class="note">(+ hair wash +â‚©20,000)</p>
<div class="price-row"><span>[ Lady ] A (daily)</span><span>â‚©45,000</span></div>
<div class="price-row"><span>B (semi up style)</span><span>â‚©60,000</span></div>
<div class="price-row"><span>C (up style)</span><span>â‚©80,000</span></div>
<div class="price-row"><span>[ Man ]</span><span>â‚©40,000</span></div>
<div class="divider"></div>
<h4>â° Early Charge (before 10:00 AM)</h4>
<div class="price-row"><span>AM 9:00 Hair</span><span>+â‚©10,000</span></div>
<div class="price-row"><span>AM 9:00 Make up</span><span>+â‚©10,000</span></div>
<div class="price-row"><span>AM 8:00 Hair</span><span>+â‚©20,000</span></div>
<div class="price-row"><span>AM 8:00 Make up</span><span>+â‚©20,000</span></div>
<div class="price-row"><span>AM 7:00 Hair</span><span>+â‚©30,000</span></div>
<div class="price-row"><span>AM 7:00 Make up</span><span>+â‚©30,000</span></div>`,

  hair: `<h4>âœ‚ï¸ Cut</h4>
<div class="price-row"><span>Lady cut</span><span>â‚©60,000~</span></div>
<div class="price-row"><span>Man cut</span><span>â‚©50,000~</span></div>
<h4>ğŸ¨ Color</h4>
<div class="price-row"><span>All color</span><span>â‚©120,000~</span></div>
<div class="price-row"><span>Root color</span><span>â‚©90,000~</span></div>
<div class="price-row"><span>Bleach</span><span>â‚©100,000~</span></div>
<div class="price-row"><span>Man color</span><span>â‚©120,000~</span></div>
<h4>ğŸŒ€ Perm</h4>
<div class="price-row"><span>Setting perm</span><span>â‚©140,000~</span></div>
<div class="price-row"><span>Down perm</span><span>â‚©120,000~</span></div>
<div class="price-row"><span>Straight</span><span>â‚©180,000~</span></div>
<div class="price-row"><span>Man perm</span><span>â‚©140,000~</span></div>
<h4>ğŸ’Š Treatment</h4>
<div class="price-row"><span>Basic</span><span>â‚©50,000~</span></div>
<div class="price-row"><span>Premium</span><span>â‚©80,000~</span></div>
<p class="note">* ê°€ê²©ì€ ê¸¸ì´/ëª¨ëŸ‰ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>* ì •í™•í•œ ê°€ê²©ì€ ìƒë‹´ í›„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.</p>`,

  spa: `<h4>ğŸ’† Head Spa</h4>
<div class="price-row"><span>Basic (30min)</span><span>â‚©60,000</span></div>
<div class="price-row"><span>Premium (60min)</span><span>â‚©100,000</span></div>
<div class="price-row"><span>Scalp scaling + Spa</span><span>â‚©120,000</span></div>`,

  photo: `<h4>ğŸ“¸ Profile / ID Photo</h4>
<div class="price-row"><span>ì¦ëª…ì‚¬ì§„ (ID)</span><span>â‚©60,000</span></div>
<div class="price-row"><span>í”„ë¡œí•„ ì´¬ì˜</span><span>â‚©120,000</span></div>
<div class="price-row"><span>ì»¤í”Œ ì´¬ì˜</span><span>â‚©220,000</span></div>
<p class="note">ğŸ“· <a class="link" href="https://www.instagram.com/mallang__id" target="_blank">@mallang__id</a></p>
<p class="note">ğŸ“· <a class="link" href="https://www.instagram.com/mallang__photo" target="_blank">@mallang__photo</a></p>`,

  booking: `<h4>ğŸ“… ì˜ˆì•½í•˜ê¸° / Reservation</h4>
<p class="note" style="margin-bottom:0.8rem;">
â€¢ ì˜ˆì•½ì¼ ê¸°ì¤€ 2ì¼ ì „ ì˜¤í›„ 6ì‹œ(KST)ê¹Œì§€ ì·¨ì†Œ ë° í™˜ë¶ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
â€¢ 1ì‹œê°„ ì´ë‚´ì— ì˜ˆì•½ê¸ˆ ê²°ì œê°€ ê°€ëŠ¥í•˜ì‹œë©´ ì•„ë˜ ë‚´ìš©ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.<br>
â€¢ ì´ê¸ˆì•¡ì—ì„œ ì˜ˆì•½ê¸ˆì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ê¸ˆì•¡ì„ í˜„ì¥ì—ì„œ ê²°ì œí•©ë‹ˆë‹¤.<br>
â€¢ ì˜ˆì•½ê¸ˆ ê²°ì œ í›„ ìŠ¤í¬ë¦°ìƒ·ì„ ê¼­ ì´ê³³ì— ë‚¨ê²¨ì£¼ì„¸ìš”. ê·¸ë ‡ì§€ ëª»í•  ê²½ìš° ì˜ˆì•½ì´ í™•ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
</p>
<div style="border-top:2px dashed #DDD;margin:1rem 0;"></div>
<p><b>ë‚ ì§œ :</b> ì›” / ì¼ ( ìš”ì¼ )</p>
<p><b>ì‹œê°„ :</b></p>
<p><b>ì´ë¦„(ì˜ë¬¸) :</b></p>
<p><b>ì¸ì› :</b></p>
<p><b>ì›í•˜ì‹œëŠ” ì„œë¹„ìŠ¤ :</b></p>
<p><b>ê²°ì œ ë°©ë²• :</b></p>
<p class="note">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ : ìœ„ì±—í˜ì´, ì•Œë¦¬í˜ì´<br>ğŸ‡¯ğŸ‡µ ì¼ë³¸ : ê³„ì¢Œì´ì²´ (í˜ì´í˜ì´ ì€í–‰)<br>ğŸ’³ ê³µìš© : ì¹´ë“œê²°ì œ</p>
<button onclick="copyBookingForm()" style="margin-top:1rem;width:100%;padding:0.7rem;background:#C9A063;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;">ğŸ“‹ ë³µì‚¬í•˜ê¸° (Copy)</button>`
};

function showMenu(tab) {
  document.querySelectorAll('.menu-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('menuContent').innerHTML = menuData[tab] || '';
}

function showPriceMenu() { toggleMobileMenu(); }
function toggleMobileMenu() {
  const sidebar = document.getElementById('menuSidebar');
  const overlay = document.getElementById('menuOverlay');
  sidebar.classList.toggle('mobile-open');
  overlay.classList.toggle('active');
  if (sidebar.classList.contains('mobile-open') && !document.getElementById('menuContent').innerHTML) {
    showMenu('makeup');
  }
}
function closeMobileMenu() {
  document.getElementById('menuSidebar').classList.remove('mobile-open');
  document.getElementById('menuOverlay').classList.remove('active');
}

function copyBookingForm() {
  const text = `ë‚ ì§œ : ì›” / ì¼ ( ìš”ì¼ )
ì‹œê°„ :
ì´ë¦„(ì˜ë¬¸) :
ì¸ì› :
ì›í•˜ì‹œëŠ” ì„œë¹„ìŠ¤ :
ê²°ì œ ë°©ë²• :`;
  navigator.clipboard.writeText(text).then(() => {
    event.target.textContent = 'âœ… ë³µì‚¬ì™„ë£Œ!';
    setTimeout(() => { event.target.textContent = 'ğŸ“‹ ë³µì‚¬í•˜ê¸° (Copy)'; }, 2000);
  });
}

// ========================================
// ìœ í‹¸ë¦¬í‹°
// ========================================
function getFlag(lang) {
  const flags = { ko: 'ğŸ‡°ğŸ‡·', en: 'ğŸŒ', zh: 'ğŸ‡¨ğŸ‡³', ja: 'ğŸ‡¯ğŸ‡µ', th: 'ğŸ‡¹ğŸ‡­', vi: 'ğŸ‡»ğŸ‡³' };
  return flags[lang] || 'ğŸŒ';
}

function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const now = new Date();
  const diff = now - d;
  if (diff < 60000) return 'ë°©ê¸ˆ';
  if (diff < 3600000) return Math.floor(diff/60000) + 'ë¶„ ì „';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'ì‹œê°„ ì „';
  return (d.getMonth()+1) + '/' + d.getDate();
}

function previewText(text) {
  if (!text) return 'ìƒˆë¡œìš´ ëŒ€í™”';
  let t = text.replace(/\[WECHAT_QR\]/g, 'ğŸ‡¨ğŸ‡³ ìœ„ì±—í˜ì´').replace(/\[DIRECTIONS_BTN\]/g, '').replace(/\n/g, ' ').trim();
  if (t.length > 35) t = t.substring(0, 35) + '...';
  return escapeHtml(t);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.appendChild(document.createTextNode(text));
  return div.innerHTML;
}

function renderMessage(text) {
  if (!text) return '';
  let html = escapeHtml(text);
  html = html.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="msg-link">$1</a>');
  html = html.replace('[WECHAT_QR]', '<img src="' + WECHAT_QR + '" class="msg-img" alt="WeChat Pay QR">');
  html = html.replace('[DIRECTIONS_BTN]', '<a href="https://www.instagram.com/reel/DIvxoGwy482/?igsh=MTI5cW8wM3MwNGM1OA==" target="_blank" class="msg-link-btn">ğŸ“ How to get here (Video)</a>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<span class="msg-highlight">$1</span>');
  html = html.replace(/\[CENTER\](.*?)\[\/CENTER\]\n?/g, '<div style="text-align:center;margin:-0.2em 0;padding:0;line-height:1.2;">$1</div>');
  html = html.replace(/\n/g, '<br>');
  return html;
}

function getAuthErrorMsg(code) {
  const msgs = {
    'auth/email-already-in-use': 'ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤ / Email already in use',
    'auth/invalid-email': 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš” / Invalid email',
    'auth/weak-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤ / Password too weak',
    'auth/user-not-found': 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤ / Email not found',
    'auth/wrong-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤ / Wrong password',
    'auth/invalid-credential': 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤ / Invalid credentials',
    'auth/too-many-requests': 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” / Too many attempts'
  };
  return msgs[code] || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (' + code + ')';
}

// ========================================
// ì…ë ¥ì°½ ìë™ í¬ê¸°
// ========================================
function autoResize(el) {
  el.style.height = 'auto';
  const maxH = 120;
  if (el.scrollHeight > maxH) {
    el.style.height = maxH + 'px';
    el.style.overflowY = 'auto';
  } else {
    el.style.height = el.scrollHeight + 'px';
    el.style.overflowY = 'hidden';
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.getElementById('chatInput').addEventListener('input', function() { autoResize(this); });
document.getElementById('staffInput').addEventListener('input', function() { autoResize(this); });
document.getElementById('chatInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) { e.preventDefault(); sendChatMsg(); }
});
document.getElementById('staffInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) { e.preventDefault(); sendStaffMsg(); }
});
document.getElementById('loginPw').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});
document.getElementById('signupPw').addEventListener('keydown', e => {
  if (e.key === 'Enter') doSignup();
});

// ì´ˆê¸° ë©”ë‰´ ë¡œë“œ
showMenu('makeup');
</script>
</body>
</html>
